#!/bin/bash

set -e

currdir=`python3 -c 'import os,sys;print(os.path.dirname(os.path.realpath(sys.argv[1])))' $0`
source $currdir/seamless-fill-environment-variables

set -u -e

docker run --rm \
  $SEAMLESS_DOCKER_PUBLISH_SHARESERVER_PORTS \
  $SEAMLESS_DOCKER_PUBLISH_DEBUG_PORTS \
  $SEAMLESS_DOCKER_RUN_PARAMS_X_NAME \
  $SEAMLESS_DOCKER_RUN_PARAMS_X_NETWORK \
  $SEAMLESS_DOCKER_RUN_PARAMS_X_DEVEL \
  $SEAMLESS_DOCKER_RUN_PARAMS_X_TRUSTED \
  -e DOCKER_IMAGE=$SEAMLESS_DOCKER_IMAGE \
  -e HOSTCWD=`pwd` \
  -e SHARESERVER_ADDRESS=$SEAMLESS_SHARESERVER_ADDRESS \
  -e SEAMLESS_DOCKER_HOST_IP=$SEAMLESS_DOCKER_HOST_IP \
  -e SEAMLESS_DEBUGGING_DIRECTORY=$SEAMLESS_DEBUGGING_DIRECTORY \
  -e SEAMLESS_DATABASE_IP=$SEAMLESS_DATABASE_IP \
  -e SEAMLESS_DATABASE_PORT=$SEAMLESS_DATABASE_PORT \
  -e SEAMLESS_COMMUNION_INCOMING=$SEAMLESS_COMMUNION_INCOMING \
  -e SEAMLESS_COMMUNION_IP=$SEAMLESS_COMMUNION_IP \
  -e SEAMLESS_COMMUNION_PORT=$SEAMLESS_COMMUNION_PORT \
  -e SEAMLESS_COMMUNION_ID=$SEAMLESS_COMMUNION_ID \
  -v `pwd`:/cwd \
  --workdir /cwd \
  -v /tmp:/tmp \
  -u `id -u` \
  --group-add users \
  -it \
  $SEAMLESS_DOCKER_IMAGE start.sh ipython3 -i /home/jovyan/seamless-scripts/serve-graph.py -- --interactive $*
